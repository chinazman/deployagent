<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>部署代理 控制台</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0;background:#0b1020;color:#e6e9ef}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#121a2b;border-bottom:1px solid #1d2742}
    main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
    .card{background:#121a2b;border:1px solid #1d2742;border-radius:12px;padding:16px}
    input,select,button,textarea{width:100%;padding:10px 12px;margin-top:8px;background:#0e1627;border:1px solid #263454;border-radius:8px;color:#e6e9ef}
    button{cursor:pointer;background:#2e5bff;border:0}
    pre{white-space:pre-wrap;word-break:break-all;background:#0a1222;border-radius:8px;padding:12px;border:1px solid #1d2742;min-height:120px}
    .row{display:flex;gap:8px}
  </style>
  <script>
    // 与 index.html 相同的基础路径发现逻辑
    (function(){
      var p=location.pathname; var i=p.indexOf('/web/');
      window.__BASE_PATH__ = i>=0 ? p.slice(0,i) : '';
    })();
  </script>
  <script>
    const BASE=(window.__BASE_PATH__||'');
    async function logout(){await fetch(BASE+'/api/logout',{method:'POST'});location.href=BASE+'/web/index.html'}
    async function deploy(e){
      e.preventDefault();
      const code=document.getElementById('code').value;
      const sigResp=await fetch(`${BASE}/api/sign?code=${encodeURIComponent(code)}`);
      if(!sigResp.ok){alert('获取签名失败');return}
      const {timestamp:ts,sign}=await sigResp.json();
      const file=document.getElementById('file').files[0];
      const fd=new FormData();
      fd.append('code',code);
      fd.append('timestamp',ts);
      fd.append('sign',sign);
      if(file) fd.append('file',file);
      const r=await fetch(BASE+'/deploy',{method:'POST',body:fd});
      document.getElementById('deployLog').textContent=await r.text();
    }
    async function listLogs(){
      const r=await fetch(BASE+'/api/logs');
      const data=await r.json();
      const sel=document.getElementById('logSelect');
      sel.innerHTML='';
      data.files.forEach(f=>{const o=document.createElement('option');o.value=f;o.textContent=f;sel.appendChild(o)});
    }
    async function viewLog(){
      const name=document.getElementById('logSelect').value;
      const start=document.getElementById('start').value||'0';
      const n=document.getElementById('lines').value||'100';
      const r=await fetch(`${BASE}/api/logs/view?file=${encodeURIComponent(name)}&start=${start}&n=${n}`);
      document.getElementById('logView').textContent=await r.text();
    }
    let es=null;
    function watchLog(){
      if(es){es.close();es=null}
      const name=document.getElementById('logSelect').value;
      es=new EventSource(`${BASE}/api/logs/tail?file=${encodeURIComponent(name)}`);
      const box=document.getElementById('logTail');
      box.textContent='';
      es.onmessage=(ev)=>{box.textContent+=ev.data+'\n';box.scrollTop=box.scrollHeight}
      // 切换按钮状态
      const btnWatch=document.getElementById('btnWatch');
      const btnCancel=document.getElementById('btnCancelWatch');
      if(btnWatch) btnWatch.disabled=true;
      if(btnCancel) btnCancel.disabled=false;
      // 若连接异常关闭，则恢复按钮状态
      es.onerror=()=>{
        // 某些浏览器会自动重连，不强制关闭；仅在 readyState=2(Closed) 时恢复
        if(es && es.readyState===2){
          const bw=document.getElementById('btnWatch');
          const bc=document.getElementById('btnCancelWatch');
          if(bw) bw.disabled=false;
          if(bc) bc.disabled=true;
          es.close(); es=null;
        }
      };
    }
    function cancelWatch(){
      if(es){ es.close(); es=null; }
      const btnWatch=document.getElementById('btnWatch');
      const btnCancel=document.getElementById('btnCancelWatch');
      if(btnWatch) btnWatch.disabled=false;
      if(btnCancel) btnCancel.disabled=true;
    }
    window.addEventListener('beforeunload',()=>{ if(es){es.close(); es=null;} });
    async function listContainers(){
      const r=await fetch(BASE+'/api/docker/ps');
      document.getElementById('dockerList').textContent=await r.text();
    }
    async function logsContainer(){
      const id=document.getElementById('containerId').value;
      const r=await fetch(`${BASE}/api/docker/logs?id=${encodeURIComponent(id)}`);
      document.getElementById('dockerLogs').textContent=await r.text();
    }
    window.addEventListener('load',()=>{listLogs();listContainers();});
  </script>
</head>
<body>
  <header>
    <div>部署代理 控制台</div>
    <div><button onclick="logout()">退出</button></div>
  </header>
  <main>
    <section class="card">
      <h3>部署</h3>
      <form onsubmit="deploy(event)">
        <label>code</label>
        <input id="code" placeholder="仅字母数字-_" required />
        <label>文件</label>
        <input id="file" type="file" />
        <button type="submit" style="margin-top:12px">执行</button>
      </form>
      <pre id="deployLog"></pre>
    </section>
    <section class="card">
      <h3>日志</h3>
      <div class="row">
        <select id="logSelect" style="flex:1"></select>
        <button onclick="listLogs()" style="width:120px">刷新</button>
      </div>
      <div class="row">
        <input id="start" placeholder="起始行(0基)" style="flex:1" />
        <input id="lines" placeholder="行数" style="width:120px" value="100" />
        <button onclick="viewLog()" style="width:120px">查看</button>
      </div>
      <pre id="logView"></pre>
      <div class="row">
        <button id="btnWatch" onclick="watchLog()">实时监控</button>
        <button id="btnCancelWatch" onclick="cancelWatch()" disabled>取消监控</button>
      </div>
      <pre id="logTail"></pre>
    </section>
    <section class="card">
      <h3>Docker</h3>
      <button onclick="listContainers()">查看容器</button>
      <pre id="dockerList"></pre>
      <div class="row">
        <input id="containerId" placeholder="容器ID/名称" style="flex:1" />
        <button onclick="logsContainer()" style="width:160px">查看日志</button>
      </div>
      <pre id="dockerLogs"></pre>
    </section>
  </main>
</body>
</html>


